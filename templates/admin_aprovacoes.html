{% extends "base_dashboard.html" %}

{% block page_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/moderacao.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_aprovacoes.css') }}">
{% endblock %}

{% block content %}
<section class="dashboard">
    <div class="container">
        <div class="dashboard-grid">
            <!-- Sidebar do Admin -->
            <div class="sidebar">
                <ul class="sidebar-menu">
                    <li><a href="/admin"><i class="fas fa-tachometer-alt"></i> Painel</a></li>
                    <li><a href="/moderacao"><i class="fas fa-gavel"></i> Moderação</a></li>
                    <li><a href="/admin/aprovacoes" class="active"><i class="fas fa-check-double"></i> Aprovações</a></li>
                    
                </ul>
            </div>
            
            <!-- Main Content -->
            <div class="main-content">
                <div class="content-header">
                    <h2 class="content-title"><i class="fas fa-check-double"></i> Painel de Aprovações</h2>
                </div>

                <!-- Tabs de Aprovações -->
                <div class="approvals-tabs">
                    <button class="approval-tab active" data-panel="exclusoes">
                        <i class="fas fa-trash-alt"></i> Exclusões de Histórico
                        {% if solicitacoes_exclusao_pendentes|length > 0 %}
                        <span class="approval-tab-badge">{{ solicitacoes_exclusao_pendentes|length }}</span>
                        {% endif %}
                    </button>
                    <button class="approval-tab" data-panel="tickets">
                        <i class="fas fa-envelope"></i> Tickets/Suporte
                        {% if tickets_pendentes|length > 0 %}
                        <span class="approval-tab-badge">{{ tickets_pendentes|length }}</span>
                        {% endif %}
                    </button>
                </div>

                <!-- Panel: Solicitações de Exclusão -->
                <div id="exclusoes" class="tab-panel active">
                    <div class="section-header">
                        <h3>Solicitações de Exclusão de Histórico - Coletores</h3>
                        <span class="badge badge-warning">Pendentes: {{ solicitacoes_exclusao_pendentes|length }}</span>
                    </div>

                    <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                        <i class="fas fa-info-circle"></i>
                        <strong>Nota:</strong> Coletores precisam de aprovação para excluir histórico. Doadores podem excluir livremente.
                    </p>

                    {% if solicitacoes_exclusao_pendentes %}
                    <div class="requests-list">
                        {% for solicitacao in solicitacoes_exclusao_pendentes %}
                        <div class="request-card request-card-pending">
                            <div class="request-header">
                                <div class="request-info">
                                    <h4 class="request-title">
                                        <i class="fas fa-user"></i>
                                        {{ solicitacao.doador.Nome }}
                                        <span class="request-type">{{ solicitacao.Tipo|capitalize }}</span>
                                    </h4>
                                    <p class="request-email"><i class="fas fa-envelope"></i> {{ solicitacao.doador.Email }}</p>
                                    <p class="request-date">
                                        <i class="fas fa-calendar"></i>
                                        Solicitado em: {{ solicitacao.Data_Solicitacao.strftime('%d/%m/%Y %H:%M') }}
                                    </p>
                                </div>
                                <div class="request-status">
                                    <span class="status-badge status-pending">Pendente</span>
                                </div>
                            </div>

                            <div class="request-actions">
                                <button class="btn btn-success btn-approve" data-request-id="{{ solicitacao.ID_Solicitacao }}">
                                    <i class="fas fa-check"></i> Aprovar
                                </button>
                                <button class="btn btn-danger btn-reject" data-request-id="{{ solicitacao.ID_Solicitacao }}">
                                    <i class="fas fa-times"></i> Rejeitar
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <p>Nenhuma solicitação de exclusão pendente.</p>
                    </div>
                    {% endif %}
                </div>

                <!-- Panel: Tickets -->
                <div id="tickets" class="tab-panel">
                    <div class="section-header">
                        <h3>Tickets de Suporte</h3>
                        <span class="badge badge-warning">Pendentes: {{ tickets_pendentes|length }}</span>
                    </div>

                    {% if tickets_pendentes %}
                    <div class="tickets-list">
                        {% for ticket in tickets_pendentes %}
                        <div class="ticket-card">
                            <div class="ticket-header">
                                <div class="ticket-user-info">
                                    <h4 class="ticket-title">
                                        <i class="fas fa-headset"></i>
                                        {{ ticket.doador.Nome }}
                                        <span class="ticket-type">{{ ticket.doador.role|capitalize }}</span>
                                    </h4>
                                    <p class="ticket-email"><i class="fas fa-envelope"></i> {{ ticket.doador.Email }}</p>
                                    <p class="ticket-date">
                                        <i class="fas fa-calendar"></i>
                                        {{ ticket.Data_Criacao.strftime('%d/%m/%Y %H:%M') }}
                                    </p>
                                </div>
                                <div class="ticket-status">
                                    <span class="status-badge status-{{ ticket.Status }}">{{ ticket.Status|capitalize }}</span>
                                </div>
                            </div>

                            <div class="ticket-content">
                                <div class="ticket-assunto">
                                    <strong>Assunto:</strong> {{ ticket.Assunto }}
                                </div>
                                <div class="ticket-mensagem">
                                    <strong>Mensagem:</strong>
                                    <p>{{ ticket.Mensagem }}</p>
                                </div>
                            </div>

                            <div class="ticket-actions">
                                <button class="btn btn-primary btn-respond" data-ticket-id="{{ ticket.ID_Ticket }}">
                                    <i class="fas fa-reply"></i> Responder
                                </button>
                                <button class="btn btn-danger btn-delete-ticket" data-ticket-id="{{ ticket.ID_Ticket }}" data-user-id="{{ ticket.ID_Doador }}">
                                    <i class="fas fa-trash"></i> Deletar
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <p>Nenhum ticket pendente.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Modal para Aprovação de Exclusão -->
<div id="approveModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Confirmar Aprovação</h2>
            <button type="button" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <p>Tem certeza que deseja aprovar essa solicitação de exclusão?</p>
            <p><strong>⚠️ Atenção:</strong> O histórico do usuário será deletado permanentemente.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeApproveModal()">Cancelar</button>
            <button type="button" class="btn btn-success" onclick="confirmApprove()">Sim, Aprovar</button>
        </div>
    </div>
</div>

<!-- Modal para Rejeição -->
<div id="rejectModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Rejeitar Solicitação</h2>
            <button type="button" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <form id="rejectForm">
                <div class="form-group">
                    <label for="motivo">Motivo da Rejeição:</label>
                    <textarea id="motivo" name="motivo" rows="4" placeholder="Explique por que a solicitação foi rejeitada..." required></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeRejectModal()">Cancelar</button>
            <button type="button" class="btn btn-danger" onclick="confirmReject()">Rejeitar</button>
        </div>
    </div>
</div>

<!-- Modal para Responder Ticket -->
<div id="respondModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Responder Ticket</h2>
            <button type="button" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <form id="respondForm">
                <div class="form-group">
                    <label for="resposta">Sua Resposta:</label>
                    <textarea id="resposta" name="resposta" rows="5" placeholder="Digite sua resposta..." required></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeRespondModal()">Cancelar</button>
            <button type="button" class="btn btn-success" onclick="confirmRespond()">Enviar Resposta</button>
        </div>
    </div>
</div>

<!-- Modal de Confirmação Dupla - Deletar Ticket -->
<div id="deleteTicketModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i> Deletar Ticket?</h2>
            <button type="button" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 12px; border-radius: 4px; margin-bottom: 15px; font-size: 13px; color: #856404;">
                <i class="fas fa-info-circle"></i>
                <strong>Atenção:</strong> Esta ação não pode ser desfeita.
            </div>
            <p>Tem certeza de que deseja deletar este ticket? Todas as mensagens e respostas serão removidas permanentemente.</p>
            <p><strong>Clique em "Confirmar Exclusão" abaixo para prosseguir:</strong></p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteTicketModal()">Cancelar</button>
            <button type="button" class="btn btn-danger" onclick="confirmDeleteTicketFinal()">Confirmar Exclusão</button>
        </div>
    </div>
</div>

<script>
    let currentRequestId = null;
    let currentTicketId = null;
    let ticketIdToDelete = null;
    let userIdOfTicket = null;

    // Tab switching
    document.querySelectorAll('.approval-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const panelName = this.getAttribute('data-panel');
            
            document.querySelectorAll('.approval-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            
            this.classList.add('active');
            document.getElementById(panelName).classList.add('active');
        });
    });

    // Exclusão - Aprovar
    document.addEventListener('click', function(event) {
        if (event.target.closest('.btn-approve')) {
            currentRequestId = event.target.closest('.btn-approve').getAttribute('data-request-id');
            document.getElementById('approveModal').classList.add('show');
        }
        
        if (event.target.closest('.btn-reject')) {
            currentRequestId = event.target.closest('.btn-reject').getAttribute('data-request-id');
            document.getElementById('rejectModal').classList.add('show');
        }

        if (event.target.closest('.btn-respond')) {
            currentTicketId = event.target.closest('.btn-respond').getAttribute('data-ticket-id');
            document.getElementById('respondModal').classList.add('show');
        }

        if (event.target.closest('.btn-delete-ticket')) {
            ticketIdToDelete = event.target.closest('.btn-delete-ticket').getAttribute('data-ticket-id');
            userIdOfTicket = event.target.closest('.btn-delete-ticket').getAttribute('data-user-id');
            document.getElementById('deleteTicketModal').classList.add('show');
        }
    });

    function closeApproveModal() {
        document.getElementById('approveModal').classList.remove('show');
        currentRequestId = null;
    }

    function confirmApprove() {
        if (!currentRequestId) return;

        fetch(`/admin/responder_exclusao/${currentRequestId}/aprovar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✅ Solicitação aprovada!');
                location.reload();
            } else {
                alert('❌ Erro: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao processar solicitação');
        });

        closeApproveModal();
    }

    function closeRejectModal() {
        document.getElementById('rejectModal').classList.remove('show');
        document.getElementById('rejectForm').reset();
        currentRequestId = null;
    }

    function confirmReject() {
        if (!currentRequestId) return;

        const motivo = document.getElementById('motivo').value.trim();
        if (!motivo) {
            alert('Por favor, preencha o motivo da rejeição');
            return;
        }

        const formData = new FormData();
        formData.append('motivo', motivo);

        fetch(`/admin/responder_exclusao/${currentRequestId}/rejeitar`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✅ Solicitação rejeitada!');
                location.reload();
            } else {
                alert('❌ Erro: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao processar solicitação');
        });

        closeRejectModal();
    }

    function closeRespondModal() {
        document.getElementById('respondModal').classList.remove('show');
        document.getElementById('respondForm').reset();
        currentTicketId = null;
    }

    function confirmRespond() {
        if (!currentTicketId) return;

        const resposta = document.getElementById('resposta').value.trim();
        if (!resposta) {
            alert('Por favor, preencha sua resposta');
            return;
        }

        const formData = new FormData();
        formData.append('resposta', resposta);

        fetch(`/admin/responder_ticket/${currentTicketId}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✅ Resposta enviada!');
                location.reload();
            } else {
                alert('❌ Erro: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao processar resposta');
        });

        closeRespondModal();
    }

    function closeDeleteTicketModal() {
        document.getElementById('deleteTicketModal').classList.remove('show');
        ticketIdToDelete = null;
        userIdOfTicket = null;
    }

    function confirmDeleteTicketFinal() {
        if (!ticketIdToDelete) return;

        fetch(`/admin/ticket/delete/${ticketIdToDelete}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✅ Ticket deletado com sucesso!');
                location.reload();
            } else {
                alert('❌ Erro: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao deletar ticket');
        });

        closeDeleteTicketModal();
    }

    // Fechar modals
    document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', function() {
            this.closest('.modal').classList.remove('show');
        });
    });

    // Fechar ao clicar fora
    window.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.classList.remove('show');
        }
    });
</script>
{% endblock %}
